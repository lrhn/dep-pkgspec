# Package-Spec

## Contact information

Name: Lasse R.H. Nielsen  
E-mail: lrn@google.com  
[DEP Proposal Location][]  
Further stakeholders:  
- Johnni Winther - johnniwinther@google.com

## Summary

Specify Dart tools' "package:" URI resolution in a separate package-specification file.

## Motivation

Dart tools currently resolve package-URIs using the "--package-root" command line parameter to specify a directory, and resolving the path-part of a package URI against this directory (defaulting to the "packages" sub-directory of the current working directory if no "--package-root" parameter is given).

This approach has some shortcomings.

First and foremost, the packages must all be represented in a centralized location of a single file system.
This is currently accomplished by creating a "packages" directory and creating a symbolic link to the "pub" cache location for each package.

Symbolic links are not working well on Windows systems, and they do not interact well with most version control systems.

Copying the contents instead of using symbolic links does not scale, with developing mutually dependent packages as a problematic use case.

Also, symbolic links can't always span multiple file systems, making it impossible to have some imports from local disk and other imports from, e.g., a HTTP server.


Using a package specification file that associates a base directory to each package name, it becomes possible to reference packages from different sources directly.
It avoids creating extra directories with symbolic links, and instead puts the same information into a single text file. Text files work flawlessly with version control systems and they can be edited with a simple text editor if needed.

## Examples

An example "pkgspec.properties" file could be:

    # auto-generated 2015-12-24 from somewhere/projectname/pubspec.yaml
    unittest=/home/somebody/.pub/cache/unittest-0.9.9/lib/
    async=/home/somebody/.pub/cache/async-1.1.0/lib/
    quiver=/home/somebody/.pub/cache/quiver-1.2.1/lib/
    # end auto-generated
    homebrew=../../libs/homebrew/lib/
    rawangular=https://raw.githubusercontent.com/angular/angular.dart/master/lib/

This package specification will allow a program run using it to import `package:unittest/unittest.dart` and receive the file `/home/somebody/.pub/cache/unittest-0.9.9/lib/unittest.dart`.

At the same time, other libraries can be fetched from the net every time they are needed, or from another project that is still in development.

I envision the comment-delimited lines have been automatically generated by the "pub" tool, while keeping the manually added lines unchanged.

## Proposal

The solution proposed here is:

- Dart tools load their "package"-URI resolution from a single file.
- The proposed default name is "pkgspec.properties".
- The file uses the Java `Properties` file format (or possibly a subset of this), thereby getting syntax support from any programming editor. This format is incredibly simple and yet does all that is needed.
- Tools that now support a "--package-root" parameter must support a "--package-spec" parameter which takes a file name as argument.

The file itself contains a list of key/value pairs.
The key is a package name - this is the first segment of a "package" URI, so the package name must be a valid URI path segment. Most (likely all) package names are identifiers, and will not require any escaping.
The value is a URI reference. It may be a relative URI, in which case it is resolved against the location of the package specification file. That is, a line like:

    homebrew=../../homebrew/lib

will be resolved relative to the location of the package file. This specifies a directory, so if the path does not end in a slash ('/'), then one will be added.

After loading and resolving the package-name/package-location pairs from the package specifcation, the tool resolves "package" URIs using this information.

For example, the URI `package:unittest/unittest.dart` is resolved by splitting it into the package name, `unittest` and the remainder of the path, `unittest.dart`.
If the `unittest` package was specified as:

    unittest=../../packages/unittest-0.9.9/lib

in the specification file `/home/somebody/dart/project/smarty/pkgspec.properties`, then the base path of the package `unittest` is `/home/somebody/dart/packages/unittest-0.9.9/lib/`. The remaining path "unittest.dart" is resolved against this, getting `/home/somebody/dart/packages/unittest-0.9.9/lib/unittest.dart`.

If a tool does not get a "--package-spec" command line parameter, it may look for a "pkgspec.properties" file in the current directory and use that as a default.


As part of the solution, the "pub" tool should be changed to allow writing a `pkgspec.properties` file where it currently creates a "package" directory.

Tools that need to support the "--package-spec" parameter includes the standalone VM, dart2js, and dart-analyzer.

## Alternatives

The simplest alternative is to keep using just the "--package-root" parameter.
The shortcomings are not crippling in most cases, but it has some problems that are not easily solved.

Alternative implementations of the same concept could be:

- Using a more complex format for the "pkgspec.properties" file, perhaps "pkgspec.yaml". This adds extra overhead and complexity, changing it from a line-based format to a structured format. This makes tools more complex, and since the file must be read on start-up, more complexity may increase the delay before code can start running. On the other hand, if we ever need to add more runtime project data, we would already have a file that we can just add more sections to.

- Allowing more than one specification file on the command line, and perhaps allow imports in specification files. This would allow reuse of existing files, and patching together a configuration from partial configurations. Again this will increase start-up latency, and will probably require a more complex format.

## Implications and limitations

Adding the package-spec as the way to configure package-URI resolution will affect start-up time for the VM. The VM will then need to load and parse the file before it can import any library through a package-URI, where it can now just check for the package's directory in the package-root when the package is first used. Unused packages cost to load the specification for, even if they are never used.

The `Isolate.spawnUri` function has a `packageRoot` parameter. It should probably be extended with a `packageSpec` parameter of type `Map<String,Uri>`.

There should be a package for reading and writing `.properties` files, and likely a library for reading and writing `pkgspec.properties` files, converting to and from `Map<String, Uri>`.

The "per package name" configuration enforces that package names are special, they are not just the first segment of path of the `package:` URI. Nothing currently prevents placing a file *in* the "package" directory, say "trick.dart" and then importing "package:trick.dart". With the package-spec file, that is no longer possible, because "trick.dart" would be seen as a package name and the file path is missing, so it would not find any file.

Making package names special may be a good thing. It allows for a later change where package URIs are normalized before using, so that "package:unittest" will be normalized to "package:unittest/unittest.dart", effectively allowing a shorthand for the default-named library of a package. With the current resolution, that is not possible - "package:unittest" may be referring to the "unittest" file in the package root directory.


## Deliverables

### Language specification changes

This change only affects tools, the language specification is unaffected.

### A working implementation

An [initial implementation] of reading and writing package specification files has been created.
This can be used as a starting point for Dart based tools to read the package specification.

### Tests

No tests have been written.

## Patents rights

TC52, the Ecma technical committee working on evolving the open [Dart standard][], operates under a royalty-free patent policy, [RFPP][] (PDF). This means if the proposal graduates to being sent to TC52, you will have to sign the Ecma TC52 [external contributer form]() and submit it to Ecma.

[DEP Proposal Location]: https://github.com/lrhn/dep-pkgspec/
[initial implementation]: https://codereview.chromium.org/772463002/
[dart standard]: http://www.ecma-international.org/publications/standards/Ecma-408.htm
[rfpp]: http://www.ecma-international.org/memento/TC52%20policy/Ecma%20Experimental%20TC52%20Royalty-Free%20Patent%20Policy.pdf
[form]: http://www.ecma-international.org/memento/TC52%20policy/Contribution%20form%20to%20TC52%20Royalty%20Free%20Task%20Group%20as%20a%20non-member.pdf
